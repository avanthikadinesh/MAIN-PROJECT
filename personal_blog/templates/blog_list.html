{% extends 'base.html' %}
{% load static %}

{% block title %}Latest Blog Posts{% endblock %}

{% block content %}
<div class="container py-5">

    <h2 class="fw-bold mb-4">Latest Blog Posts</h2>

    <!-- ðŸ” SEARCH + CATEGORY FORM -->
    <form method="GET" action="{% url 'blog_list' %}" class="row g-2 mb-4">

        <!-- Search -->
        <div class="col-md-6">
            <input
                type="text"
                name="search"
                class="form-control"
                placeholder="Search posts..."
                value="{{ search_query }}"
            >
        </div>

        <!-- Category -->
        <div class="col-md-4">
            <select name="category" class="form-select">
                <option value="All" {% if selected_category|stringformat:"s" == "All" %}selected{% endif %}>
                    All Categories
                </option>

                {% for cat in categories %}
                    <option value="{{ cat.id }}"
                        {% if selected_category|stringformat:"s" == cat.id|stringformat:"s" %}selected{% endif %}>
                        {{ cat.name }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <!-- Apply Button -->
        <div class="col-md-2">
            <button type="submit" class="btn btn-success w-100">
                Apply Filter
            </button>
        </div>

    </form>

    <!-- ðŸ“° BLOG POSTS -->
    <div class="row g-4">

        {% for post in posts %}
        <div class="col-md-6 col-xl-4">
            <div class="card h-100 border-0 shadow-sm">

                {% if post.image %}
                <img src="{{ post.image.url }}"
                     class="card-img-top"
                     style="height:200px; object-fit:cover;">
                {% endif %}

                <div class="card-body d-flex flex-column">

                    {% if post.category %}
                    <span class="badge bg-primary mb-2 align-self-start">
                        {{ post.category.name }}
                    </span>
                    {% endif %}

                    <h5 class="fw-bold">{{ post.title }}</h5>

                    <p class="text-muted">
                        {{ post.content|truncatewords:16 }}
                    </p>

                    <!-- ðŸ‘¤ AUTHOR PROFILE LINK -->
                    <a href="{% url 'author_profile' post.author.username %}"
                       class="d-flex align-items-center gap-2 mb-3 text-decoration-none text-dark">

                        <img src="{% if post.author.profile.image %}{{ post.author.profile.image.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}"
                             class="rounded-circle"
                             style="width:32px;height:32px;object-fit:cover;">

                        <div class="small text-muted">
                            {{ post.author.username }} Â·
                            {{ post.created_at|date:"M d, Y" }}
                        </div>
                    </a>

                    <div class="mt-auto">
                        <a href="{% url 'post_detail' post.id %}"
                           class="btn btn-outline-primary w-100 mb-2">
                            Read More â†’
                        </a>

                        <!-- ðŸ’¾ SAVE POST -->
                        <form method="POST" action="{% url 'toggle_save_post' post.id %}">
                            {% csrf_token %}
                            <button type="submit"
                                    class="btn btn-sm btn-outline-secondary w-100">
                                ðŸ’¾ Save
                            </button>
                        </form>
                    </div>

                </div>
            </div>
        </div>
        {% empty %}
        <p>No posts found.</p>
        {% endfor %}

    </div>

</div>
{% endblock %}